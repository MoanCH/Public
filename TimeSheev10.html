<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet Web - Suivi du Temps</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; font-weight: 300; }
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; overflow-x: auto; flex-wrap: wrap; }
        .nav-tab { padding: 12px 20px; cursor: pointer; border: none; background: none; font-size: 13px; font-weight: 500; transition: all 0.3s ease; white-space: nowrap; border-bottom: 3px solid transparent; flex-shrink: 0; }
        .nav-tab:hover { background: #e9ecef; }
        .nav-tab.active { background: white; border-bottom-color: #3498db; color: #3498db; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-card { background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #3498db; }
        .info-card h3 { color: #2c3e50; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .holidays-section { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; padding: 20px; margin-top: 20px; }
        .holidays-section h3 { color: #856404; margin-bottom: 15px; }
        .holidays-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; }
        .holiday-item { display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 5px; font-size: 14px; }
        .monthly-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .monthly-table th, .monthly-table td { border: 1px solid #ddd; padding: 4px; text-align: center; }
        .monthly-table th { background: #f5f5f5; font-weight: bold; font-size: 11px; }
        .monthly-table .date-col { width: 80px; font-weight: bold; }
        .monthly-table .day-col { width: 40px; }
        .monthly-table .time-input { width: 80px; padding: 3px; border: 1px solid #ccc; font-size: 12px; text-align: center; font-family: monospace; }
        .monthly-table .total-half { width: 60px; font-weight: bold; font-size: 11px; }
        .monthly-table .absence-select { width: 45px; font-size: 11px; }
        .monthly-table .total-col { width: 60px; font-weight: bold; }
        .monthly-table .row-weekend { background: #c5cdf2; }
        .monthly-table .row-holiday { background: #dfcef2; }
        .monthly-table .row-workday { background: white; }
        .monthly-table .total-col.alert { color: #e74c3c !important; font-weight: bold !important; }
        .bonus-col { width: 60px; font-weight: bold; color: #27ae60; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-size: 14px; }
        .report-table th, .report-table td { padding: 10px; text-align: center; border-bottom: 1px solid #e9ecef; }
        .report-table th { background: #3498db; color: white; font-weight: 500; font-size: 13px; }
        .report-table tr:hover { background: #f8f9fa; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .summary-card h3 { font-size: 1.8rem; margin-bottom: 5px; }
        .summary-card p { opacity: 0.9; font-size: 13px; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; margin: 5px; }
        .btn:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-export { background: #27ae60; }
        .btn-export:hover { background: #229954; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .floating-save { position: fixed; bottom: 30px; right: 30px; background: #e74c3c; color: white; border: none; padding: 15px 20px; border-radius: 50px; cursor: pointer; font-weight: 500; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); transition: all 0.3s ease; z-index: 1000; }
        .floating-save:hover { transform: scale(1.1); box-shadow: 0 8px 25px rgba(231, 76, 60, 0.6); }
        .legend { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; padding: 10px; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 12px; margin: 5px 0; }
        .legend-color { width: 25px; height: 20px; border-radius: 4px; border: 1px solid #ddd; }
        .legend-weekend { background: #c5cdf2; border-color: #667eea;}
        .legend-holiday { background: #dfcef2; border-color: #764ba2; }
        .legend-workday { background: white; }
        .legend-vacation-v { background: #e3f2fd; }
        .legend-vacation-m { background: #ffebee; }
        .legend-vacation-a { background: #fff3e0; }
        .legend-vacation-f { background: #f3e5f5; }
        .legend-vacation-s { background: #f1f8e9; }
        .status-panel { position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 10px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1000; max-width: 300px; }
        .status-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-green { background: #27ae60; }
        .status-orange { background: #f39c12; }
        .status-red { background: #e74c3c; }
        .upload-zone { border: 2px dashed #bdc3c7; border-radius: 10px; padding: 30px; text-align: center; margin: 20px 0; transition: all 0.3s ease; cursor: pointer; }
        .upload-zone:hover { border-color: #3498db; background: #f8f9fa; }
        .upload-zone.drag-over { border-color: #27ae60; background: #d5f4e6; }
        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #e67e22; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Timesheet Web</h1>
            <p>Suivi moderne du temps de travail avec jours f√©ri√©s Genevoise</p>
        </div>

        <div class="status-panel" id="statusPanel">
            <div class="status-item">
                <div class="status-dot status-green" id="localStorageStatus"></div>
                <span>localStorage: <span id="localStorageText">OK</span></span>
            </div>
            <div class="status-item">
                <div class="status-dot status-orange" id="autoSaveStatus"></div>
                <span>Auto-save: <span id="autoSaveText">Activ√©</span></span>
            </div>
            <div class="status-item">
                <div class="status-dot status-red" id="syncStatus"></div>
                <span>Sync: <span id="syncText">Manuel</span></span>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ecf0f1; font-size: 11px; color: #7f8c8d;">
                Derni√®re sauvegarde: <br><span id="lastSaveTime">Jamais</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('info')">üìã Information</button>
            <button class="nav-tab" onclick="showTab('jan')">üóìÔ∏è Janvier</button>
            <button class="nav-tab" onclick="showTab('feb')">üóìÔ∏è F√©vrier</button>
            <button class="nav-tab" onclick="showTab('mar')">üóìÔ∏è Mars</button>
            <button class="nav-tab" onclick="showTab('apr')">üóìÔ∏è Avril</button>
            <button class="nav-tab" onclick="showTab('may')">üóìÔ∏è Mai</button>
            <button class="nav-tab" onclick="showTab('jun')">üóìÔ∏è Juin</button>
            <button class="nav-tab" onclick="showTab('jul')">üóìÔ∏è Juillet</button>
            <button class="nav-tab" onclick="showTab('aug')">üóìÔ∏è Ao√ªt</button>
            <button class="nav-tab" onclick="showTab('sep')">üóìÔ∏è Septembre</button>
            <button class="nav-tab" onclick="showTab('oct')">üóìÔ∏è Octobre</button>
            <button class="nav-tab" onclick="showTab('nov')">üóìÔ∏è Novembre</button>
            <button class="nav-tab" onclick="showTab('dec')">üóìÔ∏è D√©cembre</button>
            <button class="nav-tab" onclick="showTab('report')">üìà Rapport</button>
            <button class="nav-tab" onclick="showTab('stats')">üìä Statistiques</button>
            <button class="nav-tab" onclick="showTab('sync')">üîÑ Synchronisation</button>
        </div>

        <div id="info" class="tab-content active">
            <div class="info-grid">
                <div class="info-card">
                    <h3>üë§ Informations Personnelles</h3>
                    <div class="form-group">
                        <label>Nom :</label>
                        <input type="text" id="lastName" placeholder="Votre nom">
                    </div>
                    <div class="form-group">
                        <label>Pr√©nom :</label>
                        <input type="text" id="firstName" placeholder="Votre pr√©nom">
                    </div>
                </div>
                <div class="info-card">
                    <h3>üìÖ P√©riode de Travail</h3>
                    <div class="form-group">
                        <label>Ann√©e :</label>
                        <input type="number" id="workYear" value="2025" onchange="updateYear()">
                    </div>
                    <div class="form-group">
                        <label>Du :</label>
                        <input type="date" id="startDate" value="2025-01-01">
                    </div>
                    <div class="form-group">
                        <label>Au :</label>
                        <input type="date" id="endDate" value="2025-12-31">
                    </div>
                </div>
                <div class="info-card">
                    <h3>üèñÔ∏è Vacances</h3>
                    <div class="form-group">
                        <label>Vacances restants ann√©e pr√©c√©dente :</label>
                        <input type="number" id="remainingVacations" value="0">
                    </div>
                    <div class="form-group">
                        <label>Vacances ann√©e courante :</label>
                        <input type="number" id="currentVacations" value="30">
                    </div>
                    <div class="form-group">
                        <label>Heures de travail standard par jour :</label>
                        <input type="number" id="standardHours" value="8" step="0.5">
                    </div>
                </div>
                <div class="info-card">
                    <h3>‚è∞ Heures Suppl√©mentaires</h3>
                    <div class="form-group">
                        <label>Heures suppl. jours ouvrables :</label>
                        <input type="number" id="overtimeWorkdays" value="0" step="0.1" placeholder="0.0" onchange="updateJanuaryCarryOver()">
                    </div>
                    <div class="form-group">
                        <label>Heures suppl. week-end et f√©ri√©s :</label>
                        <input type="number" id="overtimeWeekends" value="0" step="0.1" placeholder="0.0" onchange="updateJanuaryCarryOver()">
                    </div>
                </div>
            </div>
            <div class="holidays-section">
                <h3>üéÑ Jours F√©ri√©s pour <span id="holidayYear">2025</span></h3>
                <div class="holidays-list" id="holidaysList"></div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="loadDataFile()">üìÅ Charger</button>
                <button class="btn btn-export" onclick="saveData()">üíæ Sauvegarder</button>
                <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è Effacer</button>
            </div>
        </div>

        <div id="monthly-tabs-container"></div>

        <div id="stats" class="tab-content">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #2c3e50;">üìä Statistiques Annuelles <span id="statsYear">2025</span></h2>
                <p style="color: #666;">R√©partition des jours de travail, cong√©s et absences</p>
            </div>
            <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">R√©partition Annuelle</h3>
                <canvas id="annualStatsChart" width="800" height="400" style="width: 100%; background: white;"></canvas>
            </div>
            <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">D√©tails des Absences</h3>
                <div id="absenceDetails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
            </div>
        </div>

        <div id="sync" class="tab-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">üîÑ Gestion des Sauvegardes</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h3>üíæ Sauvegarde Locale</h3>
                    <p style="margin-bottom: 15px; color: #7f8c8d;">Les donn√©es sont automatiquement sauvegard√©es dans votre navigateur.</p>
                    <button class="btn" onclick="manualSave()">üíæ Sauvegarder Maintenant</button>
                    <button class="btn btn-export" onclick="downloadBackup()">üì• T√©l√©charger Sauvegarde</button>
                </div>
                <div class="info-card">
                    <h3>üìÅ Import/Export</h3>
                    <div class="upload-zone" onclick="triggerFileInput()" ondrop="handleDrop(event)" ondragover="allowDrop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                        üìé Cliquez ou glissez un fichier JSON ici
                    </div>
                    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
                    <button class="btn" onclick="loadDataFile()">üìÅ Charger Fichier</button>
                </div>
                <div class="info-card">
                    <h3>üóëÔ∏è Nettoyage</h3>
                    <p style="margin-bottom: 15px; color: #7f8c8d;">Effacer toutes les donn√©es stock√©es.</p>
                    <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è Tout Effacer</button>
                    <button class="btn btn-warning" onclick="clearLocalStorage()">üßπ Vider Cache</button>
                </div>
            </div>
            <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 10px; padding: 20px; margin-top: 20px;">
                <h4 style="color: #0c5460; margin-bottom: 15px;">üí° Comment √ßa marche</h4>
                <ul style="color: #0c5460; margin-left: 20px;">
                    <li><strong>Auto-save :</strong> Vos donn√©es sont automatiquement sauvegard√©es dans le navigateur</li>
                    <li><strong>T√©l√©chargement :</strong> Cr√©ez une sauvegarde fichier que vous pouvez garder</li>
                    <li><strong>Chargement :</strong> Restaurez vos donn√©es depuis un fichier de sauvegarde</li>
                    <li><strong>Synchronisation manuelle :</strong> Remplacez le fichier dans /Json/ pour partager</li>
                </ul>
            </div>
        </div>

        <div id="report" class="tab-content">
            <div class="summary-cards">
                <div class="summary-card"><h3 id="totalHours">0</h3><p>Heures Totales</p></div>
                <div class="summary-card"><h3 id="totalDays">0</h3><p>Jours Travaill√©s</p></div>
                <div class="summary-card"><h3 id="avgHours">0</h3><p>Moyenne/Jour</p></div>
                <div class="summary-card"><h3 id="expectedHours">0</h3><p>Heures Attendues</p></div>
                <div class="summary-card"><h3 id="overtime">0</h3><p>Heures Sup.</p></div>
                <div class="summary-card" id="vacationCard"><h3 id="remainingVacationsDisplay">0</h3><p>Vacances Restants</p></div>
            </div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th rowspan="2">Mois</th>
                        <th colspan="3">Heures Jours Ouvrables</th>
                        <th colspan="3">Heures Week-end/F√©ri√©s</th>
                        <th rowspan="2">Total Heures</th>
                        <th rowspan="2">Jours Travaill√©s</th>
                        <th rowspan="2">Heures Attendues</th>
                        <th rowspan="2">√âcart</th>
                        <th rowspan="2">Compensation</th>
                    </tr>
                    <tr>
                        <th>Mois</th>
                        <th>Report</th>
                        <th>Total</th>
                        <th>Mois</th>
                        <th>Report</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-export" onclick="exportData()">üì• Export CSV</button>
                <button class="btn" onclick="printReport()">üñ®Ô∏è Imprimer</button>
                <button class="btn" onclick="exportJSON()">üíæ Export JSON</button>
            </div>
        </div>
    </div>
    <div style="position: fixed; bottom: 10px; left: 20px; background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 5px; font-size: 11px; color: #666; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        ¬© 2025 JMG - juin 2025 - Version 2.4 (Update : 9 juin 2025)</br>
    </div>
    
    <button class="floating-save" onclick="autoSave()">üíæ Auto</button>

    <script>
    let timesheetData = {};
    let currentYear = 2025;
    let monthlyOvertimeData = {};
    
    // Variables globales pour r√©f√©rence
    const monthKeys = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
    const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    
    // ==========================================================================
    // CORRECTION 1: Fonction initializeMonthlyData manquante
    // ==========================================================================
    function initializeMonthlyData() {
        monthKeys.forEach(month => {
            if (!monthlyOvertimeData[month]) {
                monthlyOvertimeData[month] = {
                    workdayHours: 0,
                    weekendHours: 0,
                    carryoverWorkday: 0,
                    carryoverWeekend: 0,
                    recoveredHours: 0,
                    compensation: 'none',
                    partialRecoveryHours: 0,
                    remainingWeekendHours: 0
                };
            }
        });
    }
    
    // ==========================================================================
    // NOUVELLE PARTIE : Fonction de "Template" pour le contenu d'un mois
    // Cette fonction cr√©e le HTML pour n'importe quel mois.
    // ==========================================================================
    function createMonthTabHTML(monthKey, monthName) {
        return `
        <div id="${monthKey}" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="color: #2c3e50;" id="title-${monthKey}">${monthName} <span class="year-display">2025</span></h2>
                <div class="legend" style="margin: 0;">
                    <div class="legend-item"><div class="legend-color legend-workday"></div><span>Ouvrable</span></div>
                    <div class="legend-item"><div class="legend-color legend-weekend"></div><span>Week-end</span></div>
                    <div class="legend-item"><div class="legend-color legend-holiday"></div><span>F√©ri√©</span></div>
                    <div class="legend-item"><div class="legend-color legend-vacation-v"></div><span><span style="color: red; text-decoration: underline; font-weight: bold;">V</span>acances</span></div>
                    <div class="legend-item"><div class="legend-color legend-vacation-m"></div><span><span style="color: red; text-decoration: underline; font-weight: bold;">M</span>aladie</span></div>
                    <div class="legend-item"><div class="legend-color legend-vacation-a"></div><span><span style="color: red; text-decoration: underline; font-weight: bold;">A</span>ccident</span></div>
                    <div class="legend-item"><div class="legend-color legend-vacation-f"></div><span><span style="color: red; text-decoration: underline; font-weight: bold;">F</span>ormation</span></div>
                    <div class="legend-item"><div class="legend-color legend-vacation-s"></div><span><span style="color: red; text-decoration: underline; font-weight: bold;">S</span>p√©cial</span></div>
                </div>
            </div>
            <table class="monthly-table" id="table-${monthKey}">
                <thead>
                    <tr>
                        <th class="date-col">Date</th>
                        <th class="day-col">Jour</th>
                        <th colspan="6">Matin</th>
                        <th colspan="6">Apr√®s-midi</th>
                        <th class="total-col">Total</th>
                        <th class="total-col">Total incl.</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th>D√©but 1</th>
                        <th>Fin 1</th>
                        <th>D√©but 2</th>
                        <th>Fin 2</th>
                        <th>Total</th>
                        <th>Absences</th>
                        <th>D√©but 1</th>
                        <th>Fin 1</th>
                        <th>D√©but 2</th>
                        <th>Fin 2</th>
                        <th>Total</th>
                        <th>Absences</th>
                        <th>Heures</th>
                        <th>Bonus</th>
                    </tr>
                </thead>
                <tbody id="table-body-${monthKey}"></tbody>
            </table>
            <div class="monthly-summary" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px;">üìä R√©capitulatif du mois</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                        <h5 style="margin: 0 0 10px 0; color: #2c3e50;">Heures jours ouvrables</h5>
                        <div style="font-size: 14px;">
                            <p style="margin: 5px 0;">Total mois courant: <span id="workdayHours-${monthKey}" style="font-weight: bold;">0.0h</span></p>
                            <p style="margin: 5px 0;">Report mois pr√©c√©dent: <span id="carryoverWorkday-${monthKey}" style="font-weight: bold;">0.0h</span></p>
                            <p style="margin: 5px 0;">R√©cup√©ration week-end: <span id="recoveredHours-${monthKey}" style="font-weight: bold;">0.0h</span></p>
                            <p style="margin: 10px 0; padding-top: 10px; border-top: 1px solid #eee;">
                                <strong>Total: <span id="totalWorkdayHours-${monthKey}" style="color: #27ae60;">0.0h</span></strong>
                            </p>
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <h5 style="margin: 0 0 10px 0; color: #2c3e50;">Heures week-end et f√©ri√©s</h5>
                        <div style="font-size: 14px;">
                            <p style="margin: 5px 0;">Total mois (avec bonus): <span id="weekendHours-${monthKey}" style="font-weight: bold;">0.0h</span></p>
                            <p style="margin: 5px 0;">Report mois pr√©c√©dent: <span id="carryoverWeekend-${monthKey}" style="font-weight: bold;">0.0h</span></p>
                            <p style="margin: 10px 0; padding-top: 10px; border-top: 1px solid #eee;">
                                <strong>Total: <span id="totalWeekendHours-${monthKey}" style="color: #e74c3c;">0.0h</span></strong>
                            </p>
                        </div>
                    </div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h5 style="margin: 0 0 15px 0; color: #2c3e50;">üí∞ Compensation des heures week-end/f√©ri√©s</h5>
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="compensation-${monthKey}" value="pay" id="compensationPay-${monthKey}" onchange="updateCompensation('${monthKey}', 'pay')">
                            <span>√Ä payer</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="compensation-${monthKey}" value="partial" id="compensationPartial-${monthKey}" onchange="updateCompensation('${monthKey}', 'partial')">
                            <span>R√©cup√©ration partielle</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="compensation-${monthKey}" value="full" id="compensationFull-${monthKey}" onchange="updateCompensation('${monthKey}', 'full')">
                            <span>R√©cup√©ration compl√®te</span>
                        </label>
                    </div>
                    <div id="partialRecoveryField-${monthKey}" style="display: none; margin-top: 15px;">
                        <label style="font-size: 14px;">Heures √† r√©cup√©rer :</label>
                        <input type="number" id="partialRecoveryHours-${monthKey}" step="0.1" placeholder="0.0" 
                            style="width: 100px; padding: 5px; margin-left: 10px; border: 1px solid #ddd; border-radius: 4px;"
                            onchange="updatePartialRecovery('${monthKey}', this.value)">
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 13px;">
                        <p style="margin: 0;">Solde apr√®s compensation : <strong id="remainingWeekendHours-${monthKey}">0.0h</strong></p>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // Cette fonction initialise les donn√©es et est appel√©e quand les reports changent
    function updateJanuaryCarryOver() {
        // Assurer que monthlyOvertimeData est initialis√©
        initializeMonthlyData();

        const overtimeWorkdays = parseFloat(document.getElementById('overtimeWorkdays')?.value) || 0;
        const overtimeWeekends = parseFloat(document.getElementById('overtimeWeekends')?.value) || 0;

        if (monthlyOvertimeData['jan']) {
            monthlyOvertimeData['jan'].carryoverWorkday = overtimeWorkdays;
            monthlyOvertimeData['jan'].carryoverWeekend = overtimeWeekends;
        }

        // On force la mise √† jour de tous les calculs
        if (typeof updateReport === 'function') {
            updateReport();
        }
    }

    async function getJsonFiles() {
        try {
            const response = await fetch('./Json/', {
                method: 'GET',
            });
            if (!response.ok) {
                console.log('Dossier json non trouv√© ou inaccessible');
                return [];
            }
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const links = doc.querySelectorAll('a[href$=".json"]');
            const jsonFiles = [];
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href && href.endsWith('.json')) {
                    jsonFiles.push({
                        name: href,
                        url: `./Json/${href}`
                    });
                }
            });
            return jsonFiles;
        } catch (error) {
            console.log('Erreur lors de la lecture du dossier json:', error);
            return [];
        }
    }

    async function getFileLastModified(url) {
        try {
            const response = await fetch(url, {
                method: 'HEAD'
            });
            const lastModified = response.headers.get('Last-Modified');
            return lastModified ? new Date(lastModified) : new Date(0);
        } catch (error) {
            console.log(`Erreur lors de la v√©rification de ${url}:`, error);
            return new Date(0);
        }
    }

    async function findLatestJsonFile() {
        try {
            const jsonFiles = await getJsonFiles();
            if (jsonFiles.length === 0) {
                console.log('Aucun fichier JSON trouv√© dans ./Json/');
                return null;
            }
            console.log(`Trouv√© ${jsonFiles.length} fichier(s) JSON:`, jsonFiles.map(f => f.name));
            const filesWithDates = await Promise.all(
                jsonFiles.map(async (file) => ({ ...file,
                    lastModified: await getFileLastModified(file.url)
                }))
            );
            filesWithDates.sort((a, b) => b.lastModified - a.lastModified);
            const latestFile = filesWithDates[0];
            console.log(`Fichier le plus r√©cent: ${latestFile.name} (${latestFile.lastModified.toLocaleString()})`);
            return latestFile;
        } catch (error) {
            console.log('Erreur lors de la recherche du fichier le plus r√©cent:', error);
            return null;
        }
    }

    async function loadJsonFromUrl(url) {
        try {
            console.log(`Chargement automatique de: ${url}`);
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            loadDataIntoApp(data); // Use the centralized function
            console.log('‚úÖ Donn√©es charg√©es automatiquement !');
            showAutoLoadNotification(url);
            return true;
        } catch (error) {
            console.log(`Erreur lors du chargement automatique de ${url}:`, error);
            return false;
        }
    }

    // CORRECTION 2: Ajouter la fonction autoLoadLatestJson manquante
    async function autoLoadLatestJson() {
        try {
            const latestFile = await findLatestJsonFile();
            if (latestFile) {
                return await loadJsonFromUrl(latestFile.url);
            }
            return false;
        } catch (error) {
            console.log('Erreur lors du chargement automatique:', error);
            return false;
        }
    }

    function calculateMonthlyHoursByType(month) {
        let workdayHours = 0;
        let weekendHours = 0;
        let weekendBonusHours = 0;
        const lastDay = new Date(currentYear, month + 1, 0).getDate();
        for (let day = 1; day <= lastDay; day++) {
            const dayKey = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const date = new Date(currentYear, month, day);
            const dayOfWeek = date.getDay();
            const holiday = isHoliday(date);
            if (timesheetData[dayKey]) {
                const data = timesheetData[dayKey];
                const hours = calculateDayHours(data);
                if (hours.total > 0) {
                    if (holiday || dayOfWeek === 0 || dayOfWeek === 6) {
                        weekendHours += hours.total;
                        weekendBonusHours += calculateWeekendBonus(dayKey, hours.total);
                    } else {
                        let actualWorkdayHours = 0;
                        if (!data['absence-am'] || !['V', 'M', 'A', 'F', 'S'].includes(data['absence-am'])) {
                            actualWorkdayHours += hours.am;
                        }
                        if (!data['absence-pm'] || !['V', 'M', 'A', 'F', 'S'].includes(data['absence-pm'])) {
                            actualWorkdayHours += hours.pm;
                        }
                        workdayHours += actualWorkdayHours;
                    }
                }
            }
        }
        return {
            workdayHours: workdayHours,
            weekendHours: weekendHours,
            weekendBonusHours: weekendBonusHours
        };
    }

    function updateMonthlySummary(monthKey) {
        const monthIndex = monthKeys.indexOf(monthKey);
        const monthData = calculateMonthlyHoursByType(monthIndex);
        
        // Assurer que les donn√©es existent
        if (!monthlyOvertimeData[monthKey]) {
            monthlyOvertimeData[monthKey] = {
                workdayHours: 0, weekendHours: 0, carryoverWorkday: 0, carryoverWeekend: 0,
                recoveredHours: 0, compensation: 'none', partialRecoveryHours: 0, remainingWeekendHours: 0
            };
        }
        
        monthlyOvertimeData[monthKey].workdayHours = monthData.workdayHours;
        monthlyOvertimeData[monthKey].weekendHours = monthData.weekendBonusHours;
        
        if (monthIndex > 0) {
            const prevMonth = monthKeys[monthIndex - 1];
            const prevData = monthlyOvertimeData[prevMonth];
            const standardHours = parseFloat(document.getElementById('standardHours')?.value) || 8;
            const workingDaysInfo = getWorkingDaysInMonth(currentYear, monthIndex - 1);
            const expectedHours = workingDaysInfo.adjusted * standardHours;
            monthlyOvertimeData[monthKey].carryoverWorkday =
                prevData.workdayHours + prevData.carryoverWorkday + prevData.recoveredHours - expectedHours;
            if (prevData.compensation === 'pay') {
                monthlyOvertimeData[monthKey].carryoverWeekend = 0;
            } else {
                monthlyOvertimeData[monthKey].carryoverWeekend = prevData.remainingWeekendHours;
            }
        }
        updateMonthlySummaryDisplay(monthKey);
    }

    function updateCompensation(monthKey, type) {
        if (!monthlyOvertimeData[monthKey]) {
            monthlyOvertimeData[monthKey] = {
                workdayHours: 0, weekendHours: 0, carryoverWorkday: 0, carryoverWeekend: 0,
                recoveredHours: 0, compensation: 'none', partialRecoveryHours: 0, remainingWeekendHours: 0
            };
        }
        
        monthlyOvertimeData[monthKey].compensation = type;
        const partialField = document.getElementById(`partialRecoveryField-${monthKey}`);
        if (partialField) {
            partialField.style.display = type === 'partial' ? 'block' : 'none';
        }
        switch (type) {
            case 'pay':
                monthlyOvertimeData[monthKey].recoveredHours = 0;
                monthlyOvertimeData[monthKey].remainingWeekendHours = 0;
                break;
            case 'partial':
                const partialHours = parseFloat(document.getElementById(`partialRecoveryHours-${monthKey}`)?.value) || 0;
                updatePartialRecovery(monthKey, partialHours);
                break;
            case 'full':
                const totalWeekendHours = monthlyOvertimeData[monthKey].weekendHours +
                    monthlyOvertimeData[monthKey].carryoverWeekend;
                monthlyOvertimeData[monthKey].recoveredHours = totalWeekendHours;
                monthlyOvertimeData[monthKey].remainingWeekendHours = 0;
                break;
        }
        updateMonthlySummaryDisplay(monthKey);
        updateFollowingMonths(monthKey);
    }

    function updatePartialRecovery(monthKey, hours) {
        const partialHours = parseFloat(hours) || 0;
        const totalWeekendHours = monthlyOvertimeData[monthKey].weekendHours +
            monthlyOvertimeData[monthKey].carryoverWeekend;
        const actualRecovery = Math.min(partialHours, totalWeekendHours);
        monthlyOvertimeData[monthKey].partialRecoveryHours = actualRecovery;
        monthlyOvertimeData[monthKey].recoveredHours = actualRecovery;
        monthlyOvertimeData[monthKey].remainingWeekendHours = totalWeekendHours - actualRecovery;
        updateMonthlySummaryDisplay(monthKey);
        updateFollowingMonths(monthKey);
    }

    function updateFollowingMonths(fromMonth) {
        const startIndex = monthKeys.indexOf(fromMonth);
        for (let i = startIndex + 1; i < monthKeys.length; i++) {
            updateMonthlySummary(monthKeys[i]);
        }
    }

    function updateMonthlySummaryDisplay(monthKey) {
        const data = monthlyOvertimeData[monthKey];
        if (!data) return;
        
        const workdayHoursEl = document.getElementById(`workdayHours-${monthKey}`);
        if (workdayHoursEl) workdayHoursEl.textContent = `${data.workdayHours.toFixed(2)}h`;
        const carryoverWorkdayEl = document.getElementById(`carryoverWorkday-${monthKey}`);
        if (carryoverWorkdayEl) carryoverWorkdayEl.textContent = `${data.carryoverWorkday.toFixed(2)}h`;
        const recoveredHoursEl = document.getElementById(`recoveredHours-${monthKey}`);
        if (recoveredHoursEl) recoveredHoursEl.textContent = `${data.recoveredHours.toFixed(2)}h`;
        const totalWorkday = data.workdayHours + data.carryoverWorkday + data.recoveredHours;
        const totalWorkdayEl = document.getElementById(`totalWorkdayHours-${monthKey}`);
        if (totalWorkdayEl) totalWorkdayEl.textContent = `${totalWorkday.toFixed(2)}h`;
        const weekendHoursEl = document.getElementById(`weekendHours-${monthKey}`);
        if (weekendHoursEl) weekendHoursEl.textContent = `${data.weekendHours.toFixed(2)}h`;
        const carryoverWeekendEl = document.getElementById(`carryoverWeekend-${monthKey}`);
        if (carryoverWeekendEl) carryoverWeekendEl.textContent = `${data.carryoverWeekend.toFixed(2)}h`;
        const totalWeekend = data.weekendHours + data.carryoverWeekend;
        const totalWeekendEl = document.getElementById(`totalWeekendHours-${monthKey}`);
        if (totalWeekendEl) totalWeekendEl.textContent = `${totalWeekend.toFixed(2)}h`;
        const remainingEl = document.getElementById(`remainingWeekendHours-${monthKey}`);
        if (remainingEl) {
            const remaining = totalWeekend - data.recoveredHours;
            remainingEl.textContent = `${remaining.toFixed(2)}h`;
            monthlyOvertimeData[monthKey].remainingWeekendHours = remaining;
        }
        if (data.compensation && data.compensation !== 'none') {
            const radio = document.getElementById(`compensation${data.compensation.charAt(0).toUpperCase() + data.compensation.slice(1)}-${monthKey}`);
            if (radio) radio.checked = true;
            if (data.compensation === 'partial') {
                const partialField = document.getElementById(`partialRecoveryField-${monthKey}`);
                if (partialField) partialField.style.display = 'block';
                const partialInput = document.getElementById(`partialRecoveryHours-${monthKey}`);
                if (partialInput) partialInput.value = data.partialRecoveryHours;
            }
        }
    }

    function showAutoLoadNotification(url) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            z-index: 9999; font-size: 14px; font-weight: 500; max-width: 350px; animation: slideIn 0.3s ease-out;
        `;
        const fileName = url.split('/').pop();
        notification.innerHTML = `<div style="display: flex; align-items: center; gap: 10px;"><span style="font-size: 18px;">üìÅ</span><div><div><strong>Chargement automatique</strong></div><div style="font-size: 12px; opacity: 0.9;">${fileName}</div></div></div>`;
        if (!document.getElementById('autoLoadStyles')) {
            const style = document.createElement('style');
            style.id = 'autoLoadStyles';
            style.textContent = `@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }`;
            document.head.appendChild(style);
        }
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    function getSwissHolidays(year) {
        const holidays = [];
        holidays.push({ name: 'Nouvel An', date: new Date(year, 0, 1) });        
        const a = year % 19, b = Math.floor(year / 100), c = year % 100, d = Math.floor(b / 4), e = b % 4;
        const f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451), month = Math.floor((h + l - 7 * m + 114) / 31);
        const day = ((h + l - 7 * m + 114) % 31) + 1, easter = new Date(year, month - 1, day);
        const goodFriday = new Date(easter); goodFriday.setDate(easter.getDate() - 2);
        holidays.push({ name: 'Vendredi-Saint', date: goodFriday });
        const easterMonday = new Date(easter); easterMonday.setDate(easter.getDate() + 1);
        holidays.push({ name: 'Lundi de P√¢ques', date: easterMonday });
        const ascension = new Date(easter); ascension.setDate(easter.getDate() + 39);
        holidays.push({ name: 'Ascension', date: ascension });
        const whitMonday = new Date(easter); whitMonday.setDate(easter.getDate() + 50);
        holidays.push({ name: 'Lundi de Pentec√¥te', date: whitMonday });
        holidays.push({ name: 'F√™te nationale', date: new Date(year, 7, 1) });
        const firstSunday = new Date(year, 8, 1);
        while (firstSunday.getDay() !== 0) firstSunday.setDate(firstSunday.getDate() + 1);
        const jeuneGenevois = new Date(firstSunday); jeuneGenevois.setDate(firstSunday.getDate() + 4);
        holidays.push({ name: 'Je√ªne Genevois', date: jeuneGenevois });
        holidays.push({ name: 'No√´l', date: new Date(year, 11, 25) });
        holidays.push({ name: 'Restauration', date: new Date(year, 11, 31) });
        return holidays;
    }

    function isHoliday(date) {
        const holidays = getSwissHolidays(date.getFullYear());
        return holidays.find(holiday => holiday.date.getDate() === date.getDate() && holiday.date.getMonth() === date.getMonth());
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
        
        const tabElement = document.getElementById(tabName);
        if (tabElement) {
            tabElement.classList.add('active');
        }
        
        const clickedTab = Array.from(document.querySelectorAll('.nav-tab')).find(tab => {
            const onclick = tab.getAttribute('onclick');
            return onclick && onclick.includes(`'${tabName}'`);
        });
        if (clickedTab) {
            clickedTab.classList.add('active');
        }
    }

    function calculateHours(startTime, endTime) {
        if (!startTime || !endTime) return 0;
        const start = new Date(`2000-01-01T${startTime}`), end = new Date(`2000-01-01T${endTime}`);
        return end <= start ? 0 : (end - start) / (1000 * 60 * 60);
    }

    function calculateDayHours(dayData) {
        const am1Hours = calculateHours(dayData['am1-start'], dayData['am1-end']);
        const am2Hours = calculateHours(dayData['am2-start'], dayData['am2-end']);
        const pm1Hours = calculateHours(dayData['pm1-start'], dayData['pm1-end']);
        const pm2Hours = calculateHours(dayData['pm2-start'], dayData['pm2-end']);
        return { am: am1Hours + am2Hours, pm: pm1Hours + pm2Hours, total: am1Hours + am2Hours + pm1Hours + pm2Hours };
    }

    function getWorkingDaysInMonth(year, month) {
        let workingDays = 0, absenceHalfDays = 0;
        const lastDay = new Date(year, month + 1, 0).getDate();
        for (let day = 1; day <= lastDay; day++) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay();
            const holiday = isHoliday(date);
            if (dayOfWeek !== 0 && dayOfWeek !== 6 && !holiday) {
                workingDays++;
                const dayKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (timesheetData[dayKey]) {
                    const data = timesheetData[dayKey];
                    if (data['absence-am'] && ['V', 'M', 'A', 'F', 'S'].includes(data['absence-am'])) absenceHalfDays += 0.5;
                    if (data['absence-pm'] && ['V', 'M', 'A', 'F', 'S'].includes(data['absence-pm'])) absenceHalfDays += 0.5;
                }
            }
        }
        return { total: workingDays, adjusted: workingDays - absenceHalfDays, absences: absenceHalfDays };
    }

    function updateTimeData(dayKey, field, value) {
        if (!timesheetData[dayKey]) timesheetData[dayKey] = {};
        timesheetData[dayKey][field] = value;
        updateDayTotal(dayKey);
        const dateParts = dayKey.split('-');
        const monthIndex = parseInt(dateParts[1]) - 1;
        const monthKey = monthKeys[monthIndex];
        updateMonthlySummary(monthKey);
        updateReport();
        setTimeout(autoSave, 1000);
        updateStatusPanel();
    }

    function getAbsenceColor(type) {
        const colors = { 'V': '#e3f2fd', 'M': '#ffebee', 'A': '#fff3e0', 'F': '#f3e5f5', 'S': '#f1f8e9' };
        return colors[type] || '';
    }

    function updateAbsenceData(dayKey, period, value) {
        if (!timesheetData[dayKey]) timesheetData[dayKey] = {};
        timesheetData[dayKey][`absence-${period}`] = value;
        const inputs = period === 'am' ? ['am1-start', 'am1-end', 'am2-start', 'am2-end'] : ['pm1-start', 'pm1-end', 'pm2-start', 'pm2-end'];
        inputs.forEach(idPart => {
            const input = document.getElementById(`${idPart}-${dayKey}`);
            if(input) {
                input.disabled = !!value;
                input.value = '';
                input.style.backgroundColor = value ? getAbsenceColor(value) : '';
                if(value) timesheetData[dayKey][idPart] = '';
            }
        });
        updateDayTotal(dayKey);
        updateReport();
        setTimeout(autoSave, 1000);
        updateStatusPanel();
    }

    function addMinutesIfNeeded(input) {
        let value = input.value.trim();
        if (value) {
            if (/^\d{1,2}$/.test(value)) input.value = value.padStart(2, '0') + ':00';
            else if (/^\d{1,2}:$/.test(value)) input.value = value.replace(':', '').padStart(2, '0') + ':00';
            else if (/^\d{1,2}\.\d{2}$/.test(value)) input.value = value.replace('.', ':');
            else if (/^\d{1,2}\.\d{1}$/.test(value)) input.value = value.replace('.', ':') + '0';
            else if (/^\d{1,2}:\d{1}$/.test(value)) input.value = value + '0';
            input.dispatchEvent(new Event('change'));
        }
    }

    function updateDayTotal(dayKey) {
        const data = timesheetData[dayKey];
        if (!data) return;
        const hours = calculateDayHours(data);
        const totalAMElement = document.getElementById(`total-am-${dayKey}`);
        if(totalAMElement) totalAMElement.textContent = `${hours.am.toFixed(2)}h`;
        const totalPMElement = document.getElementById(`total-pm-${dayKey}`);
        if(totalPMElement) totalPMElement.textContent = `${hours.pm.toFixed(2)}h`;
        const totalElement = document.getElementById(`total-${dayKey}`);
        if(totalElement) {
            totalElement.textContent = `${hours.total.toFixed(2)}h`;
            const date = new Date(dayKey);
            const holiday = isHoliday(date);
            const standardHours = parseFloat(document.getElementById('standardHours')?.value) || 8;
            totalElement.classList.toggle('alert', !holiday && date.getDay() % 6 !== 0 && hours.total > 0 && hours.total < standardHours);
        }
        const bonusElement = document.getElementById(`bonus-${dayKey}`);
        if(bonusElement) {
            const bonusHours = calculateWeekendBonus(dayKey, hours.total);
            bonusElement.textContent = bonusHours > hours.total ? `${bonusHours.toFixed(2)}h` : '0.00h';
        }
    }

    function generateAllCalendars() {
        monthKeys.forEach((key, index) => generateCalendar(index));
    }

    function generateCalendar(month) {
        const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        const monthKey = monthKeys[month];
        const tbody = document.getElementById(`table-body-${monthKey}`);
        if (!tbody) return;
        tbody.innerHTML = '';
        const lastDay = new Date(currentYear, month + 1, 0).getDate();
        for (let day = 1; day <= lastDay; day++) {
            const date = new Date(currentYear, month, day);
            const dayKey = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const holiday = isHoliday(date);
            let rowClass = holiday ? 'row-holiday' : (date.getDay() % 6 === 0 ? 'row-weekend' : 'row-workday');
            const row = document.createElement('tr');
            row.className = rowClass;
            row.innerHTML = `
                <td class="date-col">${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}</td>
                <td class="day-col">${dayNames[date.getDay()]}</td>
                <td><input type="text" class="time-input" placeholder="HH:MM" id="am1-start-${dayKey}" onchange="updateTimeData('${dayKey}', 'am1-start', this.value)" onblur="addMinutesIfNeeded(this)"></td>
                <td><input type="text" class="time-input" placeholder="HH:MM" id="am1-end-${dayKey}" onchange="updateTimeData('${dayKey}', 'am1-end', this.value)" onblur="addMinutesIfNeeded(this)"></td>
                <td><input type="text" class="time-input" placeholder="HH:MM" id="am2-start-${dayKey}" onchange="updateTimeData('${dayKey}', 'am2-start', this.value)" onblur="addMinutesIfNeeded(this)"></td>
                <td><input type="text" class="time-input" placeholder="HH:MM" id="am2-end-${dayKey}" onchange="updateTimeData('${dayKey}', 'am2-end', this.value)" onblur="addMinutesIfNeeded(this)"></td>
                <td class="total-half" id="total-am-${dayKey}">0h</td>
                <td>
                    <select class="absence-select" id="absence-am-${dayKey}" onchange="updateAbsenceData('${dayKey}', 'am', this.value)">
                        <option value=""></option><option value="V">V</option><option value="M">M</option><option value="A">A</option><option value="F">F</option><option value="S">S</option>
                    </select>
                </td>
                <td><input type="text" class="time-input" placeholder="HH:MM" id="pm1-start-${dayKey}" onchange="updateTimeData('${dayKey}', 'pm1-start', this.value)" onblur="addMinutesIfNeeded(this)"></td>
                <td><input type="text" class="time-input" placeholder="HH:MM" id="pm1-end-${dayKey}" onchange="updateTimeData('${dayKey}', 'pm1-end', this.value)" onblur="addMinutesIfNeeded(this)"></td>
                <td><input type="text" class="time-input" placeholder="HH:MM" id="pm2-start-${dayKey}" onchange="updateTimeData('${dayKey}', 'pm2-start', this.value)" onblur="addMinutesIfNeeded(this)"></td>
                <td><input type="text" class="time-input" placeholder="HH:MM" id="pm2-end-${dayKey}" onchange="updateTimeData('${dayKey}', 'pm2-end', this.value)" onblur="addMinutesIfNeeded(this)"></td>
                <td class="total-half" id="total-pm-${dayKey}">0h</td>
                <td>
                    <select class="absence-select" id="absence-pm-${dayKey}" onchange="updateAbsenceData('${dayKey}', 'pm', this.value)">
                        <option value=""></option><option value="V">V</option><option value="M">M</option><option value="A">A</option><option value="F">F</option><option value="S">S</option>
                    </select>
                </td>
                <td class="total-col" id="total-${dayKey}">0h</td>
                <td class="bonus-col" id="bonus-${dayKey}">0h</td>
            `;
            tbody.appendChild(row);
        }
        loadCalendarData(month);
    }

    function calculateWeekendBonus(dayKey, totalHours) {
        if (totalHours === 0) return 0;
        const date = new Date(dayKey);
        const dayOfWeek = date.getDay();
        const holiday = isHoliday(date);
        let bonusRate = 1;
        if (holiday || dayOfWeek === 0) bonusRate = 1.5;
        else if (dayOfWeek === 6) bonusRate = 1.25;
        return totalHours * bonusRate;
    }

    function loadCalendarData(month) {
        const lastDay = new Date(currentYear, month + 1, 0).getDate();
        for (let day = 1; day <= lastDay; day++) {
            const dayKey = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            if (timesheetData[dayKey]) {
                const data = timesheetData[dayKey];
                const timeInputs = ['am1-start', 'am1-end', 'am2-start', 'am2-end', 'pm1-start', 'pm1-end', 'pm2-start', 'pm2-end'];
                timeInputs.forEach(inputType => {
                    const input = document.getElementById(`${inputType}-${dayKey}`);
                    if (input && data[inputType]) input.value = data[inputType];
                });
                const absenceAM = document.getElementById(`absence-am-${dayKey}`);
                if (absenceAM && data['absence-am']) {
                    absenceAM.value = data['absence-am'];
                    updateAbsenceData(dayKey, 'am', data['absence-am']);
                }
                const absencePM = document.getElementById(`absence-pm-${dayKey}`);
                if (absencePM && data['absence-pm']) {
                    absencePM.value = data['absence-pm'];
                    updateAbsenceData(dayKey, 'pm', data['absence-pm']);
                }
                updateDayTotal(dayKey);
            }
        }
    }

    function updateAllYearDisplays() {
        document.querySelectorAll('.year-display').forEach(span => span.textContent = currentYear);
        const statsYear = document.getElementById('statsYear');
        if (statsYear) statsYear.textContent = currentYear;
        const holidayYear = document.getElementById('holidayYear');
        if (holidayYear) holidayYear.textContent = currentYear;
    }

    function updateYear() {
        const newYear = parseInt(document.getElementById('workYear').value);
        if (newYear && newYear !== currentYear) {
            currentYear = newYear;
            document.getElementById('startDate').value = `${currentYear}-01-01`;
            document.getElementById('endDate').value = `${currentYear}-12-31`;
            updateAllYearDisplays();
            generateAllCalendars();
            updateHolidaysList();
            updateReport();
        }
    }

    function updateHolidaysList() {
        const holidays = getSwissHolidays(currentYear);
        const holidaysList = document.getElementById('holidaysList');
        if (!holidaysList) return;
        holidaysList.innerHTML = '';
        holidays.forEach(holiday => {
            const holidayDiv = document.createElement('div');
            holidayDiv.className = 'holiday-item';
            holidayDiv.innerHTML = `<span>${holiday.name}</span><span>${holiday.date.toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric', month: 'short'})}</span>`;
            holidaysList.appendChild(holidayDiv);
        });
    }

    function updateReport() {
        let totalHours = 0, totalDaysWorked = 0, totalExpectedHours = 0, vacationDaysTaken = 0;
        const standardHours = parseFloat(document.getElementById('standardHours')?.value) || 8;
        const monthlyData = [];
        for (let month = 0; month < 12; month++) {
            const monthKey = monthKeys[month];
            updateMonthlySummary(monthKey);
            const monthOvertimeData = monthlyOvertimeData[monthKey];
            let monthDaysWorked = 0;
            const workingDaysInfo = getWorkingDaysInMonth(currentYear, month);
            const adjustedWorkingDays = workingDaysInfo.adjusted;
            const lastDay = new Date(currentYear, month + 1, 0).getDate();
            for (let day = 1; day <= lastDay; day++) {
                const dayKey = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const date = new Date(dayKey);
                if (timesheetData[dayKey] && !isHoliday(date) && date.getDay() % 6 !== 0) {
                    const data = timesheetData[dayKey];
                    const hours = calculateDayHours(data);
                    let dayWorkedAmount = 0;
                    if (!data['absence-am'] && hours.am > 0) dayWorkedAmount += 0.5;
                    if (!data['absence-pm'] && hours.pm > 0) dayWorkedAmount += 0.5;
                    monthDaysWorked += dayWorkedAmount;
                    if (data['absence-am'] === 'V') vacationDaysTaken += 0.5;
                    if (data['absence-pm'] === 'V') vacationDaysTaken += 0.5;
                }
            }
            const monthExpectedHours = adjustedWorkingDays * standardHours;
            const totalWorkdayHours = monthOvertimeData.workdayHours + monthOvertimeData.carryoverWorkday + monthOvertimeData.recoveredHours;
            const totalWeekendHours = monthOvertimeData.weekendHours + monthOvertimeData.carryoverWeekend;
            const monthTotalHours = monthOvertimeData.workdayHours + monthOvertimeData.weekendHours;
            totalHours += monthTotalHours;
            totalDaysWorked += monthDaysWorked;
            totalExpectedHours += monthExpectedHours;
            const compensationType = monthOvertimeData.compensation === 'pay' ? 'Pay√©' :
                monthOvertimeData.compensation === 'partial' ? `Partiel (${monthOvertimeData.partialRecoveryHours.toFixed(2)}h)` :
                monthOvertimeData.compensation === 'full' ? 'Complet' : '-';
            monthlyData.push({
                name: monthNames[month],
                workdayMonth: monthOvertimeData.workdayHours.toFixed(2),
                workdayCarryover: monthOvertimeData.carryoverWorkday.toFixed(2),
                workdayTotal: totalWorkdayHours.toFixed(2),
                weekendMonth: monthOvertimeData.weekendHours.toFixed(2),
                weekendCarryover: monthOvertimeData.carryoverWeekend.toFixed(2),
                weekendTotal: totalWeekendHours.toFixed(2),
                totalHours: monthTotalHours.toFixed(2),
                daysWorked: monthDaysWorked.toFixed(2),
                expectedHours: monthExpectedHours.toFixed(2),
                difference: (totalWorkdayHours - monthExpectedHours).toFixed(2),
                compensation: compensationType
            });
        }
        const overtime = totalHours - totalExpectedHours;
        const totalHoursEl = document.getElementById('totalHours');
        if (totalHoursEl) totalHoursEl.textContent = totalHours.toFixed(2);
        const totalDaysEl = document.getElementById('totalDays');
        if (totalDaysEl) totalDaysEl.textContent = totalDaysWorked.toFixed(2);
        const avgHoursEl = document.getElementById('avgHours');
        if (avgHoursEl) avgHoursEl.textContent = totalDaysWorked > 0 ? (totalHours / totalDaysWorked).toFixed(2) : '0.00';
        const expectedHoursEl = document.getElementById('expectedHours');
        if (expectedHoursEl) expectedHoursEl.textContent = totalExpectedHours.toFixed(2);
        const overtimeEl = document.getElementById('overtime');
        if (overtimeEl) {
            overtimeEl.textContent = overtime.toFixed(2);
            overtimeEl.style.color = overtime >= 0 ? '#27ae60' : '#e74c3c';
        }
        const remainingVacationsPrevYear = parseFloat(document.getElementById('remainingVacations')?.value) || 0;
        const currentVacationsDays = parseFloat(document.getElementById('currentVacations')?.value) || 0;
        const totalVacationDays = remainingVacationsPrevYear + currentVacationsDays;
        const remainingVacationsEl = document.getElementById('remainingVacationsDisplay');
        if (remainingVacationsEl) remainingVacationsEl.textContent = (totalVacationDays - vacationDaysTaken).toFixed(2);
        const tbody = document.getElementById('reportTableBody');
        if (tbody) {
            tbody.innerHTML = '';
            monthlyData.forEach(month => {
                const row = document.createElement('tr');
                const differenceClass = parseFloat(month.difference) >= 0 ? 'style="color: #27ae60"' : 'style="color: #e74c3c"';
                row.innerHTML = `<td><strong>${month.name}</strong></td><td>${month.workdayMonth}h</td><td>${month.workdayCarryover}h</td><td><strong>${month.workdayTotal}h</strong></td><td>${month.weekendMonth}h</td><td>${month.weekendCarryover}h</td><td style="color: #e74c3c;"><strong>${month.weekendTotal}h</strong></td><td><strong>${month.totalHours}h</strong></td><td>${month.daysWorked}</td><td>${month.expectedHours}h</td><td ${differenceClass}><strong>${month.difference}h</strong></td><td><small>${month.compensation}</small></td>`;
                tbody.appendChild(row);
            });
            const totalRow = document.createElement('tr');
            totalRow.style.cssText = 'border-top: 2px solid #3498db; font-weight: bold;';
            totalRow.innerHTML = `<td>TOTAL</td><td colspan="6"></td><td>${totalHours.toFixed(2)}h</td><td>${totalDaysWorked.toFixed(2)}</td><td>${totalExpectedHours.toFixed(2)}h</td><td style="color: ${overtime >= 0 ? '#27ae60' : '#e74c3c'}">${overtime.toFixed(2)}h</td><td></td>`;
            tbody.appendChild(totalRow);
        }
        createAnnualStatsChart();
    }

    function createAnnualStatsChart() {
        const canvas = document.getElementById('annualStatsChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let workDays = 0, weekends = 0, holidays = 0, vacationDays = 0, sickDays = 0, accidentDays = 0, trainingDays = 0, specialDays = 0;
        for (let month = 0; month < 12; month++) {
            const lastDay = new Date(currentYear, month + 1, 0).getDate();
            for (let day = 1; day <= lastDay; day++) {
                const date = new Date(currentYear, month, day);
                const dayOfWeek = date.getDay();
                if (isHoliday(date)) holidays++;
                else if (dayOfWeek % 6 === 0) weekends++;
                else {
                    let worked = true;
                    const dayKey = `${currentYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    if (timesheetData[dayKey]) {
                        const data = timesheetData[dayKey];
                        if (data['absence-am']) { if(data['absence-am']==='V') vacationDays+=0.5; else if(data['absence-am']==='M') sickDays+=0.5; else if(data['absence-am']==='A') accidentDays+=0.5; else if(data['absence-am']==='F') trainingDays+=0.5; else if(data['absence-am']==='S') specialDays+=0.5; }
                        if (data['absence-pm']) { if(data['absence-pm']==='V') vacationDays+=0.5; else if(data['absence-pm']==='M') sickDays+=0.5; else if(data['absence-pm']==='A') accidentDays+=0.5; else if(data['absence-pm']==='F') trainingDays+=0.5; else if(data['absence-pm']==='S') specialDays+=0.5; }
                        if ((data['absence-am'] && data['absence-pm']) || calculateDayHours(data).total === 0) worked = false;
                    }
                    if(worked) workDays++;
                }
            }
        }
        weekends = weekends/2; // Count pairs of Sat/Sun
        const chartData = [
            { label: 'Jours travaill√©s', value: workDays, color: '#27ae60' }, { label: 'Week-ends', value: weekends, color: '#95a5a6' },
            { label: 'Jours f√©ri√©s', value: holidays, color: '#f39c12' }, { label: 'Vacances', value: vacationDays, color: '#3498db' },
            { label: 'Maladie', value: sickDays, color: '#e74c3c' }, { label: 'Accident', value: accidentDays, color: '#e67e22' },
            { label: 'Formation', value: trainingDays, color: '#9b59b6' }, { label: 'Sp√©cial', value: specialDays, color: '#34495e' }
        ].filter(d => d.value > 0);
        if (chartData.length === 0) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const maxValue = Math.max(...chartData.map(item => item.value));
        const barWidth = (canvas.width - 100) / chartData.length - 20;
        chartData.forEach((item, index) => {
            const barHeight = (item.value / maxValue) * (canvas.height - 80);
            const x = 50 + (index * (barWidth + 20));
            const y = canvas.height - 40 - barHeight;
            ctx.fillStyle = item.color;
            ctx.fillRect(x, y, barWidth, barHeight);
            ctx.fillStyle = '#2c3e50';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(item.value, x + barWidth/2, y - 5);
            ctx.save();
            ctx.translate(x + barWidth/2, canvas.height - 15);
            ctx.rotate(-Math.PI/6);
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.fillText(item.label, 0, 0);
            ctx.restore();
        });
        const absenceDetails = document.getElementById('absenceDetails');
        if (absenceDetails) {
             absenceDetails.innerHTML = chartData.map(d => `<div style="text-align: center; padding: 15px; background-color:${d.color}20; border-radius: 8px;"><h4 style="color: ${d.color}; margin: 0 0 5px 0;">${d.value}</h4><p style="margin: 0; font-size: 14px;">${d.label}</p></div>`).join('');
        }
    }

    function gatherAllData() {
        return {
            personal: {
                lastName: document.getElementById('lastName')?.value || '',
                firstName: document.getElementById('firstName')?.value || '',
                workYear: document.getElementById('workYear')?.value || '2025',
                startDate: document.getElementById('startDate')?.value || '2025-01-01',
                endDate: document.getElementById('endDate')?.value || '2025-12-31',
                remainingVacations: document.getElementById('remainingVacations')?.value || '0',
                currentVacations: document.getElementById('currentVacations')?.value || '30',
                standardHours: document.getElementById('standardHours')?.value || '8',
                overtimeWorkdays: document.getElementById('overtimeWorkdays')?.value || '0',
                overtimeWeekends: document.getElementById('overtimeWeekends')?.value || '0'
            },
            timesheet: timesheetData,
            monthlyOvertime: monthlyOvertimeData,
            timestamp: new Date().toISOString()
        };
    }

    function loadDataFile() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.click();
    }

    // CORRECTION 3: Ajouter la fonction saveData manquante
    function saveData() {
        downloadBackup();
    }

    function autoSave() {
        try {
            const dataStr = JSON.stringify(gatherAllData());
            localStorage.setItem('timesheetData', dataStr);
            localStorage.setItem('timesheetLastSave', Date.now().toString());
            console.log('‚úÖ Sauvegarde automatique r√©ussie');
            const saveBtn = document.querySelector('.floating-save');
            if (saveBtn) {
                saveBtn.innerHTML = '‚úÖ Sauv√©';
                saveBtn.style.background = '#27ae60';
                setTimeout(() => {
                    saveBtn.innerHTML = 'üíæ Auto';
                    saveBtn.style.background = '#e74c3c';
                }, 2000);
            }
            updateStatusPanel();
            return true;
        } catch (error) {
            console.error('‚ùå Erreur sauvegarde automatique:', error);
            return false;
        }
    }

    function updateStatusPanel() {
        const lastSave = localStorage.getItem('timesheetLastSave');
        const localStorageStatusEl = document.getElementById('localStorageStatus');
        const localStorageTextEl = document.getElementById('localStorageText');
        const lastSaveTimeEl = document.getElementById('lastSaveTime');
        
        if (localStorageStatusEl && localStorageTextEl) {
            localStorageStatusEl.className = `status-dot status-${localStorage.getItem('timesheetData') ? 'green' : 'red'}`;
            localStorageTextEl.textContent = localStorage.getItem('timesheetData') ? 'Donn√©es pr√©sentes' : 'Aucune donn√©e';
        }
        
        if (lastSaveTimeEl) {
            lastSaveTimeEl.textContent = lastSave ? new Date(parseInt(lastSave)).toLocaleString('fr-FR') : 'Jamais';
        }
    }

    function manualSave() { autoSave(); }
    
    function downloadBackup() {
        const dataStr = JSON.stringify(gatherAllData(), null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const timestamp = now.toISOString().slice(0,19).replace(/-/g,"").replace(/:/g,"").replace("T","_");
        a.download = `timesheet_backup_${timestamp}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    function clearLocalStorage() {
        if (confirm('üßπ Vider le cache du navigateur ?')) {
            localStorage.clear();
            location.reload();
        }
    }
    
    function triggerFileInput() { 
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.click(); 
    }
    
    function handleFileSelect(event) {
        if (event.target.files.length) loadFromFile(event.target.files[0]);
    }

    function allowDrop(e) { e.preventDefault(); }
    function dragEnter(e) { e.preventDefault(); e.target.classList.add('drag-over'); }
    function dragLeave(e) { e.target.classList.remove('drag-over'); }
    function handleDrop(e) {
        e.preventDefault();
        e.target.classList.remove('drag-over');
        if (e.dataTransfer.files.length) loadFromFile(e.dataTransfer.files[0]);
    }

    function loadFromFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                loadDataIntoApp(data);
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        };
        reader.readAsText(file);
    }

    function loadDataIntoApp(data) {
        if (data.personal) {
            Object.keys(data.personal).forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = data.personal[field];
            });
            currentYear = parseInt(data.personal.workYear) || currentYear;
        }
        if (data.timesheet) timesheetData = data.timesheet;
        if (data.monthlyOvertime) monthlyOvertimeData = data.monthlyOvertime;
        else initializeMonthlyData();
        
        updateAllYearDisplays();
        generateAllCalendars();
        updateHolidaysList();
        monthKeys.forEach(key => updateMonthlySummaryDisplay(key));
        updateReport();
        updateStatusPanel();
        autoSave();
    }

    function loadFromLocalStorage() {
        const savedData = localStorage.getItem('timesheetData');
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                loadDataIntoApp(data);
                return true;
            } catch (error) {
                console.error('Erreur lors du chargement depuis localStorage:', error);
                return false;
            }
        }
        return false;
    }

    // Ajouter les fonctions manquantes
    function exportData() {
        // Fonction d'export CSV - impl√©mentation simplifi√©e
        console.log('Export CSV non impl√©ment√©');
    }
    
    function printReport() {
        window.print();
    }
    
    function exportJSON() {
        downloadBackup();
    }
    
    function resetAllData() {
        if (confirm('‚ö†Ô∏è Effacer toutes les donn√©es ?')) {
            localStorage.clear();
            location.reload();
        }
    }
    
    document.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === 's') { e.preventDefault(); autoSave(); }
        if (e.ctrlKey && e.key === 'p') { e.preventDefault(); printReport(); }
    });

    // --- MODIFICATION : Logique d'initialisation de la page ---
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ Initialisation...');

        // 1. G√©n√©ration dynamique du HTML des mois
        const container = document.getElementById('monthly-tabs-container');
        if (container) {
            let allMonthsHTML = '';
            for (let i = 0; i < 12; i++) {
                allMonthsHTML += createMonthTabHTML(monthKeys[i], monthNames[i]);
            }
            container.innerHTML = allMonthsHTML;
        }

        // 2. Initialisation des donn√©es mensuelles
        initializeMonthlyData();

        // 3. Le reste de l'initialisation (qui peut maintenant trouver les √©l√©ments cr√©√©s)
        updateJanuaryCarryOver();
        updateAllYearDisplays();
        generateAllCalendars();
        updateHolidaysList();
        updateReport();
        updateStatusPanel();

        // 4. Chargement des donn√©es (local ou serveur)
        if (!loadFromLocalStorage()) {
            await autoLoadLatestJson();
        }
        
        setInterval(autoSave, 300000); // 5 minutes auto-save
        
        console.log('‚úÖ Application pr√™te !');
    });
   </script>
</body>
</html>
